{% extends "base.html" %}
{% load static %}
{% block content %}
    <section class="py-16 bg-white">
        <div class="max-w-4xl mx-auto px-4">
            <div class="mb-12 text-center">
                <h2 class="text-3xl font-bold text-green-700">Přihláška ke členství</h2>
                <p class="text-gray-700 mt-2 leading-relaxed">
                    Vyplňte prosím následující formulář pro podání přihlášky do WPA CZ-SK.
                </p>
            </div>
            <form method="post" action="">
                {% csrf_token %}
                {{ form.non_field_errors }}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <!-- First name -->
                        <div id="first-name-group">
                            {{ form.first_name.label_tag }} {{ form.first_name }}
                            <p id="first-name-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.first_name.errors %}<p class="text-red-600 text-sm mt-1">{{ form.first_name.errors.0 }}</p>{% endif %}
                        </div>
                        <!-- Academic title -->
                        <div id="academic-title-group">
                            {{ form.academic_title.label_tag }} {{ form.academic_title }}
                            <p id="academic-title-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.academic_title.errors %}
                                <p class="text-red-600 text-sm mt-1">{{ form.academic_title.errors.0 }}</p>
                            {% endif %}
                        </div>
                        <div id="phone-number-group">
                            {{ form.phone_number.label_tag }} {{ form.phone_number }}
                            <p id="phone-number-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.phone_number.errors %}<p class="text-red-600 text-sm mt-1">{{ form.phone_number.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                    <div class="space-y-4">
                        <!-- Last name -->
                        <div id="last-name-group">
                            {{ form.last_name.label_tag }} {{ form.last_name }}
                            <p id="last-name-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.last_name.errors %}<p class="text-red-600 text-sm mt-1">{{ form.last_name.errors.0 }}</p>{% endif %}
                        </div>
                        <!-- Birth date -->
                        <div id="birth-date-group">
                            {{ form.birth_date.label_tag }} {{ form.birth_date }}
                            <p id="birth-date-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.birth_date.errors %}<p class="text-red-600 text-sm mt-1">{{ form.birth_date.errors.0 }}</p>{% endif %}
                        </div>
                        <!-- Email -->
                        <div id="email-group">
                            {{ form.email.label_tag }}
                            {{ form.email }}
                            <p id="email-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.email.errors %}<p class="text-red-600 text-sm mt-1">{{ form.email.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>
                <hr class="my-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <!-- Street -->
                        <div id="street-group">
                            {{ form.street.label_tag }} {{ form.street }}
                            <p id="street-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.street.errors %}<p class="text-red-600 text-sm mt-1">{{ form.street.errors.0 }}</p>{% endif %}
                        </div>
                        <!-- Postal code -->
                        <div id="postal-code-group">
                            {{ form.postal_code.label_tag }} {{ form.postal_code }}
                            <p id="postal-code-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.postal_code.errors %}<p class="text-red-600 text-sm mt-1">{{ form.postal_code.errors.0 }}</p>{% endif %}
                        </div>
                        <!-- District -->
                        <div id="district-group">
                            {{ form.district.label_tag }} {{ form.district }}
                            <p id="district-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.district.errors %}<p class="text-red-600 text-sm mt-1">{{ form.district.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                    <div class="space-y-4">
                        <!-- House number -->
                        <div id="house-number-group">
                            {{ form.house_number.label_tag }} {{ form.house_number }}
                            <p id="house-number-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.house_number.errors %}<p class="text-red-600 text-sm mt-1">{{ form.house_number.errors.0 }}</p>{% endif %}
                        </div>
                        <!-- City -->
                        <div id="city-group">
                            {{ form.city.label_tag }} {{ form.city }}
                            <p id="city-error" class="text-red-600 text-sm mt-1"></p>
                            {% if form.city.errors %}<p class="text-red-600 text-sm mt-1">{{ form.city.errors.0 }}</p>{% endif %}
                        </div>
                        {{ form.country.label_tag }}{{ form.country }}{{ form.country.errors }}
                    </div>
                </div>
                <hr class="my-6">
                <div class="mt-6">
                    <!-- Notes -->
                    <div id="notes-group">
                        {{ form.notes.label_tag }} {{ form.notes }}
                        <p id="notes-error" class="text-red-600 text-sm mt-1"></p>
                        {% if form.notes.errors %}<p class="text-red-600 text-sm mt-1">{{ form.notes.errors.0 }}</p>{% endif %}
                    </div>
                </div>
                <div class="mt-6">
                    <label class="flex items-start space-x-2 text-sm text-gray-700">
                        {{ form.agree_membership_terms }}
                        <span>
                            Souhlasím s
                            <a href="{% url 'membership_terms' %}"
                               target="_blank"
                               class="underline text-green-700 hover:text-green-900">podmínkami přihlášky</a>
                            a členství ve spolku WPA CZ-SK.
                        </span>
                    </label>
                    {% if form.agree_membership_terms.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.agree_membership_terms.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="mt-6">
                    <label class="flex items-start space-x-2 text-sm text-gray-700">
                        {{ form.agree_gdpr }}
                        <span>
                            Souhlasím se
                            <a href="{% url 'gdpr' %}"
                               target="_blank"
                               class="underline text-green-700 hover:text-green-900">zpracováním osobních údajů</a>
                            dle zásad WPA CZ-SK.
                        </span>
                    </label>
                    {% if form.agree_gdpr.errors %}<p class="text-red-600 text-sm mt-1">{{ form.agree_gdpr.errors.0 }}</p>{% endif %}
                </div>
                <hr class="my-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                    <!-- V -->
                    <div id="declaration-place-group">
                        {{ form.declaration_place.label_tag }} {{ form.declaration_place }}
                        <p id="declaration-place-error" class="text-red-600 text-sm mt-1"></p>
                        {% if form.declaration_place.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.declaration_place.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <!-- Dne -->
                    <div id="declaration-date-group">
                        {{ form.declaration_date.label_tag }} {{ form.declaration_date }}
                        <p id="declaration-date-error" class="text-red-600 text-sm mt-1"></p>
                        {% if form.declaration_date.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.declaration_date.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <!-- Podpis -->
                    <div id="declaration-signature-group">
                        {{ form.declaration_signature.label_tag }} {{ form.declaration_signature }}
                        <p id="declaration-signature-error" class="text-red-600 text-sm mt-1"></p>
                        {% if form.declaration_signature.errors %}
                            <p class="text-red-600 text-sm mt-1">{{ form.declaration_signature.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                <hr class="my-6">
                <div style="display:none;">{{ form.honeypot }}</div>
                <!-- reCAPTCHA -->
                <div class="mt-8 flex justify-center">
                    <div class="text-center">
                        {{ form.captcha }}
                        {% if form.captcha.errors %}<p class="text-red-600 text-sm mt-1">{{ form.captcha.errors.0 }}</p>{% endif %}
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button type="submit"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold px-8 py-3 rounded-full shadow">
                        Odeslat přihlášku
                    </button>
                </div>
            </form>
        </div>
    </section>
{% endblock %}
{% block extra_js %}
    <script>
  const firstNameInput = document.querySelector("#id_first_name");
  const firstNameError = document.querySelector("#first-name-error");
  const lastNameInput = document.querySelector("#id_last_name");
  const lastNameError = document.querySelector("#last-name-error");
  const emailInput = document.querySelector("#id_email");
  const emailError = document.querySelector("#email-error");
  const academicTitleInput = document.querySelector("#id_academic_title");
  const academicTitleError = document.querySelector("#academic-title-error");
  const birthDateInput = document.querySelector("#id_birth_date");
  const birthDateError = document.querySelector("#birth-date-error");
  const phoneNumberInput = document.querySelector("#id_phone_number");
  const phoneNumberError = document.querySelector("#phone-number-error");
  const streetInput = document.querySelector("#id_street");
  const streetError = document.querySelector("#street-error");
  const houseNumberInput = document.querySelector("#id_house_number");
  const houseNumberError = document.querySelector("#house-number-error");
  const cityInput = document.querySelector("#id_city");
  const cityError = document.querySelector("#city-error");
  const districtInput = document.querySelector("#id_district");
  const districtError = document.querySelector("#district-error");
  const postalCodeInput = document.querySelector("#id_postal_code");
  const postalCodeError = document.querySelector("#postal-code-error");
  const notesInput = document.querySelector("#id_notes");
  const notesError = document.querySelector("#notes-error");
  const containsHtmlTags = (text) => /<[^>]+>/.test(text);
  const declarationPlaceInput = document.querySelector("#id_declaration_place");
  const declarationPlaceError = document.querySelector("#declaration-place-error");
  const declarationSignatureInput = document.querySelector("#id_declaration_signature");
  const declarationSignatureError = document.querySelector("#declaration-signature-error");


  const nameRegex = /^[A-Za-zÁÉÍÓÚÝĎŤŇŘŠČŽáéíóúýďťňřščžäëïöüÄËÏÖÜ' -]+$/;
  const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  const academicTitleRegex = /^[A-Za-zÁÉÍÓÚÝĎŤŇŘŠČŽáéíóúýďťňřščž. ]+$/;
  const phoneNumberRegex = /^\+\d{8,15}$/;
  const streetRegex = /^[A-Za-zÁÉÍÓÚÝČĎĚŇŘŠŤŽáéíóúýčďěňřšťž0-9\s.\-\/]+$/;
  const houseNumberRegex = /^[0-9A-Za-zÁÉÍÓÚÝČĎĚŇŘŠŤŽáéíóúýčďěňřšťž\s\/\-]+$/;
  const locationRegex = /^[A-Za-zÁÉÍÓÚÝĎŤŇŘŠČŽäëïöüÄËÏÖÜáéíóúýďťňřščž0-9.,()'\- ]+$/;
  const postalCodeRegex = /^[\w\s\-]{3,10}$/;


  // Name validation
  const handleNameValidation = (input, errorElem, fieldLabel) => {
    input.addEventListener("input", () => {
      const value = input.value.trim();

      if (value === "") {
        errorElem.textContent = "";
        return;
      }

      if (value.length < 2) {
        errorElem.textContent = `${fieldLabel} musí mít alespoň 2 znaky.`;
      } else if (!nameRegex.test(value)) {
        errorElem.textContent = `${fieldLabel} může obsahovat pouze písmena, mezery, pomlčky nebo apostrof.`;
      } else {
        errorElem.textContent = "";
      }
    });

    input.addEventListener("blur", () => {
      if (input.value.trim() === "") {
        errorElem.textContent = "";
      }
    });
  };

  handleNameValidation(firstNameInput, firstNameError, "Jméno");
  handleNameValidation(lastNameInput, lastNameError, "Příjmení");

  // Email validation
  emailInput.addEventListener("input", () => {
    const value = emailInput.value.trim();

    if (value === "") {
      emailError.textContent = "";
      return;
    }

    emailError.textContent = emailRegex.test(value)
      ? ""
      : "Zadejte platnou e-mailovou adresu.";
  });

  emailInput.addEventListener("blur", () => {
    if (emailInput.value.trim() === "") {
      emailError.textContent = "";
    }
  });

  // Academic title validation
  academicTitleInput.addEventListener("input", () => {
    const value = academicTitleInput.value.trim();

    if (value === "") {
      academicTitleError.textContent = "";
      return;
    }

    academicTitleError.textContent = academicTitleRegex.test(value)
      ? ""
      : "Titul může obsahovat pouze písmena, mezery a tečky.";
  });

  academicTitleInput.addEventListener("blur", () => {
    if (academicTitleInput.value.trim() === "") {
      academicTitleError.textContent = "";
    }
  });

  // Birth date validation
  const isOver18 = (dateStr) => {
    const today = new Date();
    const birthDate = new Date(dateStr);
    const age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    return age > 18 || (age === 18 && (m > 0 || (m === 0 && today.getDate() >= birthDate.getDate())));
  };

  const isInFuture = (dateStr) => {
    const birthDate = new Date(dateStr);
    const today = new Date();
    return birthDate > today;
  };

  const isTooOld = (dateStr) => {
    const birthDate = new Date(dateStr);
    return birthDate.getFullYear() < 1900;
  };

  birthDateInput.addEventListener("input", () => {
    const value = birthDateInput.value.trim();

    if (value === "") {
      birthDateError.textContent = "";
      return;
    }

    if (isTooOld(value)) {
      birthDateError.textContent = "Datum narození musí být po roce 1900.";
    } else if (isInFuture(value)) {
      birthDateError.textContent = "Datum narození nemůže být v budoucnosti.";
    } else if (!isOver18(value)) {
      birthDateError.textContent = "Musíte být starší 18 let.";
    } else {
      birthDateError.textContent = "";
    }
  });

  birthDateInput.addEventListener("blur", () => {
    if (birthDateInput.value.trim() === "") {
      birthDateError.textContent = "";
    }
  });

  // Phone number validation
  phoneNumberInput.addEventListener("input", () => {
    const value = phoneNumberInput.value.trim();

    if (value === "") {
      phoneNumberError.textContent = "";
      return;
    }

    if (!phoneNumberRegex.test(value)) {
      phoneNumberError.textContent = "Zadejte telefonní číslo v mezinárodním formátu, např. +420123456789.";
    } else {
      phoneNumberError.textContent = "";
    }
  });

  phoneNumberInput.addEventListener("blur", () => {
    if (phoneNumberInput.value.trim() === "") {
      phoneNumberError.textContent = "";
    }
  });

  // Street validation
streetInput.addEventListener("input", () => {
  const value = streetInput.value.trim();

  if (value === "") {
    streetError.textContent = "";
    return;
  }

  if (!streetRegex.test(value)) {
    streetError.textContent = "Ulice může obsahovat pouze písmena, čísla, mezery, pomlčky, tečky a lomítka.";
  } else {
    streetError.textContent = "";
  }
});

streetInput.addEventListener("blur", () => {
  if (streetInput.value.trim() === "") {
    streetError.textContent = "";
  }
});

// House number validation
houseNumberInput.addEventListener("input", () => {
  const value = houseNumberInput.value.trim();

  if (value === "") {
    houseNumberError.textContent = "";
    return;
  }

  if (!houseNumberRegex.test(value)) {
    houseNumberError.textContent = "Číslo domu může obsahovat pouze čísla, písmena, mezery, lomítka a pomlčky.";
  } else {
    houseNumberError.textContent = "";
  }
});

houseNumberInput.addEventListener("blur", () => {
  if (houseNumberInput.value.trim() === "") {
    houseNumberError.textContent = "";
  }
});

// City validation
cityInput.addEventListener("input", () => {
  const value = cityInput.value.trim();
  if (value === "") {
    cityError.textContent = "";
    return;
  }

  if (!locationRegex.test(value)) {
    cityError.textContent = "Použijte platný název města – povolena písmena, čísla, tečky, čárky, pomlčky.";
  } else {
    cityError.textContent = "";
  }
});

cityInput.addEventListener("blur", () => {
  if (cityInput.value.trim() === "") {
    cityError.textContent = "";
  }
});

// District validation
districtInput.addEventListener("input", () => {
  const value = districtInput.value.trim();

  if (value === "") {
    districtError.textContent = "";
    return;
  }

  if (!locationRegex.test(value)) {
    districtError.textContent = "Použijte platný název okresu – povolena písmena, čísla, pomlčky, tečky.";
  } else {
    districtError.textContent = "";
  }
});

districtInput.addEventListener("blur", () => {
  if (districtInput.value.trim() === "") {
    districtError.textContent = "";
  }
});

// Postal code validation
postalCodeInput.addEventListener("input", () => {
  const value = postalCodeInput.value.trim();

  if (value === "") {
    postalCodeError.textContent = "";
    return;
  }

  postalCodeError.textContent = postalCodeRegex.test(value)
    ? ""
    : "Zadejte platné PSČ – čísla, písmena, mezery, pomlčky.";
});

postalCodeInput.addEventListener("blur", () => {
  if (postalCodeInput.value.trim() === "") {
    postalCodeError.textContent = "";
  }
});

// Notes validation
notesInput.addEventListener("input", () => {
  const value = notesInput.value.trim();
  if (value.length > 256) {
    notesError.textContent = "Poznámka může mít maximálně 256 znaků.";
  } else if (containsHtmlTags(value)) {
    notesError.textContent = "Poznámka nesmí obsahovat HTML značky.";
  } else {
    notesError.textContent = "";
  }
});

notesInput.addEventListener("blur", () => {
  if (notesInput.value.trim() === "") {
    notesError.textContent = "";
  }
});

// Declaration place
declarationPlaceInput.addEventListener("input", () => {
  const value = declarationPlaceInput.value.trim();
  if (value === "") {
    declarationPlaceError.textContent = "";
    return;
  }
  if (!locationRegex.test(value)) {
    declarationPlaceError.textContent = "Zadejte platný název místa – pouze písmena, čísla, mezery.";
  } else {
    declarationPlaceError.textContent = "";
  }
});

// Declaration signature
declarationSignatureInput.addEventListener("input", () => {
  const value = declarationSignatureInput.value.trim();
  if (value === "") {
    declarationSignatureError.textContent = "";
    return;
  }
  if (!nameRegex.test(value)) {
    declarationSignatureError.textContent = "Podpis může obsahovat pouze jméno – písmena, mezery, pomlčky.";
  } else {
    declarationSignatureError.textContent = "";
  }
});
    </script>
{% endblock %}
